<!DOCTYPE html>

<html>

<head>

  <title>HotLogo@WebMSX</title>

  <meta charset="UTF-8">

  <link rel="shortcut icon" type="image/x-icon" href="https://github.com/arkanon/arkanon.github.io/blob/master/favicon.ico?raw=true">

  <script src="https://rawgit.com/ppeccin/WebMSX/master/release/stable/4.0/embedded/wmsx.js"></script>
  <script src="https://rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js"></script>
  <script src="https://rawgit.com/antimatter15/ocrad.js/master/ocrad.js"></script>
  <script>

    defaul = '@MSX1_NTSC.bios'
    hotbit = url('msxpro.com/hardware/roms/hotbit12.zip')
    expert = url('msxpro.com/hardware/roms/expert11.zip')

 // WMSX.BASIC_ENTER     = tr('mudecor 15 1 mudecf 15 mudect 6 mudecl 4 esc proporção')
 // WMSX.BASIC_ENTER     = tr('esc proporção')
 // WMSX.BASIC_TYPE      = tr('un pt 30 ul repita 360 [ pf 1 pe 1 ] mudeproporção 1 repita 360 [ pf 1 pd 1 ]')

    WMSX.CARTRIDGE1_URL  = defaul
 // WMSX.CARTRIDGE1_URL  = hotbit
 // WMSX.CARTRIDGE1_URL  = expert
    WMSX.CARTRIDGE2_URL  = url( 'icongames.com.br/msxfiles/apps/hotlogo.zip' )
    WMSX.DISKA_FILES_URL = git( 'arkanon','dipohlo','webmsx-disk.zip'        )
 // WMSX.STATE_URL       = git( 'arkanon','dipohlo','webmsx-hotlogo.wst'     )

    WMSX.SCREEN_ELEMENT_ID     = 'wmsx-scr'
    WMSX.MACHINE               = 'MSX1A'
    WMSX.CPU_TURBO_MODE        = 1
    WMSX.AUTO_POWER_ON_DELAY   = 0
    WMSX.SCREEN_CONTROL_BAR    = 1
    WMSX.SCREEN_DEFAULT_ASPECT = 1.0
    WMSX.SCREEN_DEFAULT_SCALE  = 0.5
 // WMSX.SCREEN_DEFAULT_SCALE  = 2.2
    WMSX.SCREEN_FILTER_MODE    = 0

    function url(url)            { return 'https://cors-anywhere.herokuapp.com/' + url } // <http://alternativeto.net/software/cors-proxy>
    function git(user,repo,path) { return 'https://rawgit.com/' + user + '/' + repo + '/gh-pages/' + path }
    function setMachine(url)     { WMSX.room.fileLoader.readFromURL(url, WMSX.ROM, 'auto', true, true); WMSX.room.machine.reset() }

    map = {
            'ã': '±'    ,
            'â': '' ,
            'é': '' ,
            'í': '¡'    ,
            'ó': '¢'    ,
            'ú': '£'    ,
            'ç': '' ,
            'º': '§'    ,
            'π': '¾'    ,
          }

    function tr(str)
    {
      var re = new RegExp( '['+Object.keys(map).join('')+']', 'g' )
      return str.replace( re, function(m) { return map[m] } )
    }

    function transfer(cmd)
    {
      cmd = cmd || 0
      var input = document.getElementById('input-box')
      if (cmd) input.value = cmd
      if (input.value.substr(input.value.length-1)!='\n') input.value += '\n'
      WMSX.room.keyboard.typeString(tr(input.value))
    }

    function progressUpdate(data)
    {
      var ocr  = document.getElementById('ocr-box-tesseract')
      var line = document.createElement('div')
      line.appendChild(document.createTextNode(data.text))
      ocr.insertBefore(line, ocr.firstChild)
    }

    function screenshot()
    {
      ss.src = scr.toDataURL('image/png')
      document.querySelector('#ocr-box-ocrad').innerHTML = OCRAD(scr)
      document.querySelector('#ss-scr').src = ss.src
      document.querySelector('#ocr-box-tesseract').innerHTML = ''
      Tesseract.recognize( ss.src, { lang: 'por' } ).then( function(data) { progressUpdate( data ) } )
    }



    // <https://developer.mozilla.org/en-US/docs/Web/API/Pointer_Lock_API>
    function canvasDraw()
    {
      overlay_ctx.clearRect(0, 0, overlay.width, overlay.height);
      overlay_ctx.fillStyle = 'rgba(0,255,0,.5)'
      overlay_ctx.beginPath()
      overlay_ctx.fillRect(cx, cy, side, side)
      overlay_ctx.fill()
    }

    function lockChangeAlert(e)
    {

      if (document.pointerLockElement === overlay || document.mozPointerLockElement === overlay)
      {
        var rect = overlay.getBoundingClientRect()
        cx = x - rect.left
        cy = y - rect.top
        console.log('The pointer lock status is now locked')
        document.addEventListener("mousemove", updatePosition, false)
      }
      else
      {
        console.log('The pointer lock status is now unlocked')
        document.removeEventListener("mousemove", updatePosition, false)
      }

    }

    function getMousePos(e)
    {
      var ev = (!e) ? window.event : e // IE:Moz
      x = ev.pageX
      y = ev.pageY
    }

    function updatePosition(e)
    {

   // var x     = (e.layerX-2)/s
   // var y     = (e.layerY-2)/s
      var pixel = scr_ctx.getImageData(cx/s, cy/s, s, s)
      var data  = pixel.data
      var r     = data[0]
      var g     = data[1]
      var b     = data[2]
      var a     = data[3]/255
      var rgba  = 'rgba('+r+', '+g+', '+b+', '+a+')'
      scan.style.background = rgba
      scan.style.background = rgba

      cx += e.movementX
      cy += e.movementY
      if (cx > overlay.width  + side) cx = -side
      if (cy > overlay.height + side) cy = -side
      if (cx < -side)                 cx = overlay.width  + side
      if (cy < -side)                 cy = overlay.height + side

      scan.innerHTML  = '<p>'
                      + cx+' '+cy
                      + '<br>'
                      + '<br>'
                      + r+' '+g+' '+b+' '+a
                      + '</p>'

      if (!animation)
      {
        animation = requestAnimationFrame(function()
        {
          animation = null
          canvasDraw()
        })
      }
    }



    window.onmousemove = getMousePos

    window.onload = function(e)
    {

      scan    = document.getElementById('scan-box')
      overlay = document.getElementById('overlay')
      scr     = document.getElementById('wmsx-screen-canvas')
      ss      = document.getElementById('ss')
      var i   = document.getElementById('ss-scr')

      scr_ctx     = scr.getContext('2d')
      overlay_ctx = overlay.getContext('2d')

      var w   = WMSX.SCREEN_DEFAULT_SCALE * scr.width
      var h   = WMSX.SCREEN_DEFAULT_SCALE * scr.height
      ss.style.width  = w + 'px'
      ss.style.height = h + 'px'
      i.width         = w
      i.height        = h
      s               = WMSX.SCREEN_DEFAULT_SCALE
      side            = 16*s
      cx              = 0
      cy              = 0

//    scr.addEventListener('mousemove', colorpick)

      overlay.width   = s*scr.width
      overlay.height  = s*scr.height
      overlay.onclick = function() { overlay.requestPointerLock() }
      canvasDraw()

      // pointer lock object forking for cross browser
      overlay.requestPointerLock = overlay.requestPointerLock || overlay.mozRequestPointerLock
        document.exitPointerLock = document.exitPointerLock   ||  document.mozExitPointerLock

      // hook pointer lock state change events for different browsers
      document.addEventListener('pointerlockchange'   , lockChangeAlert, false)
      document.addEventListener('mozpointerlockchange', lockChangeAlert, false)

    }



    var scr, ss, s, side, scan, overlay, scr_ctx, overlay_ctx, x, y, cx, cy, animation

    console.log(WMSX)



  </script>

  <style>

    @font-face
    {
      font-family: screen0;
      src: url(https://cors-anywhere.herokuapp.com/ateijelo.com/assets/misc/MSX-Screen0.ttf);
    }

    @font-face
    {
      font-family: screen1;
      src: url(https://cors-anywhere.herokuapp.com/ateijelo.com/assets/misc/MSX-Screen1.ttf);
    }

    body
    {
      margin: 5px;
      background: #292929;
      text-space-collapse: trim-inner; /* not working */
    }

    a
    {
      text-decoration: none;
      outline: none;
      color: white;
    }

    #scan-block,
    #input-block,
    #wmsx-block,
    #ss-block,
    .ocr-block
    {
      display: inline-block;
      vertical-align: top;
    }

    #ss-block
    {
      cursor: url(https://www.carambis.com/static/new/programs/icon/ss_icon.png), auto !important;
    }

    #scan-header,
    #input-header,
    #wmsx-header,
    #ss-header,
    .ocr-header
    {
      font-family: sans-serif;
      color: white;
      display: block;
    }

    #input-header:hover,
    #wmsx-header:hover,
    .ocr-header:hover
    {
      color: red;
    }

    #wmsx
    {
      position: relative;
      text-align: center;
    }

    pre
    {
      margin: 0;
    }

    #wmsx-scr,
    #wmsx-bar
    {
      border: 0 !important;
    }

    #scan,
    #input,
    #wmsx-screen-canvas-outer,
    #ss,
    .ocr
    {
      border: 1px solid red;
    }

    #ss-scr
    {
      image-rendering: pixelated;
    }

    #scan,
    #input,
    #wmsx-screen-canvas-outer,
    .ocr
    {
      background: white;
    }

    #input-box,
    #ocr-box-ocrad,
    #ocr-box-tesseract
    {
      font-family: screen1;
      font-size: 7px;
      line-height: 8px;
      transform: scale(1.14,1);
      transform-origin: 0 0;
      border: 0;
      margin: 0;
      padding: 0;
      white-space: pre-wrap;
    }

    #scan-box
    {
      font-family: screen1;
      font-size: 14px;
      text-align: center;
      width: 100%;
      height: 192px;
      display: table;
    }

    #scan-box > p
    {
      display: table-cell;
      vertical-align: middle;
    }

    #scan,
    #input,
    .ocr
    {
      padding: 8px 16px;
      width: 240px;
      margin: 0;
    }

    #input
    {
      height: 192px;
    }

    #scan,
    .ocr
    {
      min-height: 192px;
    }

    #ocr-box-ocrad,
    #ocr-box-tesseract
    {
      overflow: none;
    }

    input
    {
      height: 30px;
      padding-left: 10px;
      padding-right: 10px;
      margin-top: 3px;
      margin-left: 3px;
      border: 1px solid black;
      border-radius: 5px;
    }

    input:hover
    {
      background: lightgray;
    }

    :focus { outline: none; }
    ::-moz-focus-inner { border: 0; }

    #input-box
    {
      overflow: hidden;
      resize: none;
      word-wrap: break-word;
    }

    #wmsx-scr
    {
      position: relative;
    }

    #overlay
    {
      position: absolute;
      top: 0;
      left: 0;
      display: block;
      margin: 0;
      border: 1px solid transparent;
      z-index: 9999;
    }

  </style>

</head>

<body>

  <div id="input-block">
    <a id="input-header" href="http://ateijelo.com/blog/2016/09/13/making-an-msx-font" target="_blank">Input</a>
    <div id="input">
       <textarea id="input-box" rows="24" cols="28" wrap="soft" spellcheck="false">

mudecor 15 1
mudecf 15
mudect 6
mudecl 4
esc proporção

repita 360 [ pf 1 pe 1 ]
mudeproporção 1
repita 360 [ pf 1 pd 1 ]

ad dt mudecor 15 1

esc " esc [ã â é í ó ú ç º π] esc "
</textarea>
     </div>
     <input type="button" value="TYPE"            onclick="transfer()"><!--
  --><input type="button" value="att"             onclick="transfer('att')"><!--
  --><input type="button" value="ad"              onclick="transfer('ad')"><!--
  --><input type="button" value="dt"              onclick="transfer('dt')"><!--
  --><input type="button" value="at"              onclick="transfer('at')"><!--
  --><br><!--
  --><input type="button" value="preto no branco" onclick="transfer('mudecor 15 1 mudecf 15 mudect 1 mudecl 1')"><!--
  --><input type="button" value="rg"              onclick="transfer('rg')"><!--
  --><br><!--
  --><input type="button" value="arquivos"        onclick="transfer('arquivos')"><!--
  --><input type="button" value="carregue"        onclick="transfer('carregue &quot;bamba')"><!--
--></div>

  <div id="wmsx-block">
    <a id="wmsx-header" href="http://github.com/ppeccin/webmsx" target="_blank">WebMSX</a>
    <div id="wmsx">
      <div id="wmsx-scr"></div>
      <canvas id="overlay"></canvas>
    </div>
    <input type="button" value="Default" onclick="setMachine(defaul)"><!--
 --><input type="button" value="HotBit"  onclick="setMachine(hotbit)"><!--
 --><input type="button" value="Expert"  onclick="setMachine(expert)">
  </div>

  <div id="scan-block">
    <div id="scan-header">Screen Scan</div>
    <div id="scan">
      <div id="scan-box"></div>
    </div>
  </div>

  <br>
  <br>

  <div id="ss-block" onclick="screenshot()">
    <div id="ss-header">ScreenShot</div>
    <div id="ss"><img id="ss-scr"></div>
  </div>

  <div class="ocr-block">
    <a class="ocr-header" href="http://github.com/antimatter15/ocrad.js" target="_blank">OCR (ocrad)</a>
    <div class="ocr">
      <div id="ocr-box-ocrad">
      </div>
    </div>
  </div>

  <div class="ocr-block">
    <a class="ocr-header" href="http://github.com/naptha/tesseract.js" target="_blank">OCR (tesseract)</a>
    <div class="ocr">
      <div id="ocr-box-tesseract">
      </div>
    </div>
  </div>

</body>

</html>
